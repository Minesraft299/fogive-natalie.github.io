
/**
 * ForgiveMe-Natalie Bot
 * Creates a PR asking Natalie for forgiveness üíñ
 */
module.exports = (app) => {
  app.on("installation.created", async (context) => {
    const { repositories } = context.payload;
    for (const repo of repositories) {
      const owner = repo.owner.login;
      const repoName = repo.name;

      const branchName = "forgive-natalie";

      // Create a branch from default branch
      const { data: repoData } = await context.octokit.repos.get({
        owner,
        repo: repoName,
      });

      const defaultBranch = repoData.default_branch;
      const { data: refData } = await context.octokit.git.getRef({
        owner,
        repo: repoName,
        ref: `heads/${defaultBranch}`,
      });

      await context.octokit.git.createRef({
        owner,
        repo: repoName,
        ref: `refs/heads/${branchName}`,
        sha: refData.object.sha,
      });

      // Create/Update README.md with forgiveness note
      const message = `
# üíå Dear Natalie

Hi Natalie,  

I know I don‚Äôt always talk much, but it‚Äôs never because I don‚Äôt care.  
You‚Äôre really important to me.  

I‚Äôm sorry if my quietness upset you.  
**Will you forgive me?** ‚ù§Ô∏è

‚Äî Your friend
      `.trim();

      // Get current README (if exists)
      let sha;
      try {
        const { data: fileData } = await context.octokit.repos.getContent({
          owner,
          repo: repoName,
          path: "README.md",
        });
        sha = fileData.sha;
      } catch (err) {
        // No README yet
      }

      await context.octokit.repos.createOrUpdateFileContents({
        owner,
        repo: repoName,
        path: "README.md",
        message: "üôè Asking Natalie for forgiveness",
        content: Buffer.from(message).toString("base64"),
        branch: branchName,
        sha,
      });

      // Open a Pull Request
      await context.octokit.pulls.create({
        owner,
        repo: repoName,
        title: "üíñ Forgive me, Natalie",
        head: branchName,
        base: defaultBranch,
        body: "This PR is my way of asking for your forgiveness, Natalie. If you merge it, it means we‚Äôre good again. ‚ú®",
      });
    }
  });
};
